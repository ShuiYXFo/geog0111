<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Prof P. Lewis">
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>GDAL Timeseries - GEOG0111</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "GDAL Timeseries";
    var mkdocs_page_input_path = "041_GDAL_timeseries.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> GEOG0111</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Course Basics</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../001_Notebook_use/">Notebook Use</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../002_Unix/">Unix</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../003_Help/">Help</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../004_Accounts/">Accounts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../005_Packages/">Packages</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Answers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../001_Notebook_use_answers/">Notebook Use</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../002_Unix_answers/">Unix</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../003_Help_answers/">Help</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Core Concepts</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../010_Python_Introduction/">Python Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../011_Python_data_types/">Python Data Types</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../012_Python_strings/">Python Strings</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../013_Python_string_methods/">Python String Methods</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../014_Python_groups/">Python Groups</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../015_Python_control/">Python Control</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../016_Python_for/">Python For</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../017_Functions/">Functions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../018_Running_Python/">Running Python</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Answers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../010_Python_Introduction_answers/">Python Introduction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../011_Python_data_types_answers/">Python Data Types</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../012_Python_strings_answers/">Python Strings</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../013_Python_string_methods_answers/">Python String Methods</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../014_Python_groups_answers/">Python Groups</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../015_Python_control_answers/">Python Control</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../016_Python_for_answers/">Python For</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../017_Functions_answers/">Functions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../018_Running_Python_answers/">Running Python</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Data Basics</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../020_Python_files/">Python Files</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../021_Streams/">Streams</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../022_Read_write_files/">Read Write Files</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../023_Plotting/">Plotting</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../024_Image_display/">Image Display</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Answers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../020_Python_files_answers/">Python Files</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../021_Streams_answers/">Streams</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../022_Read_write_files_answers/">Read Write Files</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../023_Plotting_answers/">Plotting</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../024_Image_display_answers/">Image Display</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Array Data</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../030_NASA_MODIS_Earthdata/">NASA MODIS Earthdata</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../031_Numpy/">Numpy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../032_More_numpy/">More Numpy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Answers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../030_NASA_MODIS_Earthdata_answers/">NASA MODIS Earthdata</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../031_Numpy_answers/">Numpy</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../032_More_numpy_answers/">More Numpy</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Geospatial Data</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../040_GDAL_mosaicing_and_masking/">GDAL Mosaicing And Masking</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">GDAL Timeseries</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#purpose">Purpose</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#test">Test</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#timeseries">Timeseries</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#exercise-1">Exercise 1</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#modisget_modis">Modis.get_modis</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#a-year-of-data">A year of data</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#plotting-time-series">Plotting time series</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#exercise-2">Exercise 2</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#uncertainty-and-weighting">Uncertainty and weighting</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#exercise-3">Exercise 3</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../042_Weighted_smoothing_and_interpolation/">Weighted Smoothing And Interpolation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../043_Weighted_interpolation/">Weighted Interpolation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Answers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../040_GDAL_mosaicing_and_masking_answers/">GDAL Mosaicing And Masking</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../041_GDAL_timeseries_answers/">GDAL Timeseries</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../043_Weighted_interpolation_answers/">Weighted Interpolation</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Modelling</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../050_Models/">Models</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../051_Phenology_model/">Phenology Model</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Answers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../050_Models_answers/">Models</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../051_Phenology_model_answers/">Phenology Model</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Assessment</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../060_Groups/">Groups</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../061_Script/">Script</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../062_Part1/">Part1</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../063_Part1_code/">Part1 Code</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../064_Numpy/">Numpy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../065_LAI/">Lai</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../066_Part2/">Part2</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Answers</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../060_Groups_answers/">Groups</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../061_Script_answers/">Script</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../064_Numpy_answers/">Numpy</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../065_LAI_answers/">Lai</a>
                </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Summary</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../070_Summary/">Summary</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">GEOG0111</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Geospatial Data &raquo;</li>
        
      
    
    <li>GDAL Timeseries</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/UCL-EO/geog0111/edit/master/docs/041_GDAL_timeseries.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="041-gdal-time-series">041 GDAL: time series</h1>
<h3 id="purpose">Purpose</h3>
<p>In this section, we'll continue to look at the MODIS LAI, with a view to forming a time series dataset. AT the end of this session, you will be able to generate a 3D numpy array of some MODIS geophysical variable for a selcted area and time.</p>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li><a href="../030_NASA_MODIS_Earthdata/">030_NASA_MODIS_Earthdata</a></li>
<li><a href="../031_Numpy/">031_Numpy</a></li>
<li><a href="../032_More_numpy/">032_more_numpy</a></li>
<li><a href="../040_GDAL_mosaicing_and_masking/">040_GDAL_mosaicing_and_masking</a></li>
</ul>
<p>You must make sure you can recall the details of the work covered in <a href="../040_GDAL_mosaicing_and_masking/">040_GDAL_mosaicing_and_masking</a>. You will also need to know how to do <a href="../023_Plotting/">graph plotting</a>, including sub-figures and errorbars, and <a href="../024_Image_display/">image display</a>.</p>
<h3 id="test">Test</h3>
<p>You should run a <a href="../004_Accounts/">NASA account test</a> if you have not already done so.</p>
<h2 id="timeseries">Timeseries</h2>
<p>We can conveniently generate a timeseries dataset using the <code>gdal</code> VRT file approach we used in <a href="../040_GDAL_mosaicing_and_masking/">040_GDAL_mosaicing_and_masking</a>. </p>
<p>In this case, the main process would be:</p>
<pre><code>- initialise band name list bnames
- initialise list sds_set
- loop over some set of doy values:
    - retrieve an SDS for each doy
    - make a band name for the doy/year
    - stitch tiles together into one VRT
    - append the new SDS to the list sds_set
    - append the band name to the list bnames
</code></pre>
<pre><code class="python">import gdal
from geog0111.modis import Modis

kwargs = {
    'tile'      :    ['h17v03','h18v03'],
    'product'   :    'MCD15A3H',
    'sds'       :    'Lai_500m',
}
year = 2019
# list of doys we want
# - every 4 days for MCD15A3H
doys = [41,45,49]

modis = Modis(**kwargs)

# initialise list sds_set
sds_set = []
bnames = []

# loop over some set of doy values:
for doy in doys:
    # retrieve an SDS for each doy
    files,sds = modis.get_files(year,doy)
    # choose only the first SDS for now
    this_sds = sds[0]

    # make a band name for the doy/year
    bandname = f'{year}-{doy:0&gt;3d}'

    # stitch tiles together into one VRT
    # called ofile
    ofile = f&quot;work/stitch_{modis.product}.{doy}.vrt&quot;
    stitch_vrt = gdal.BuildVRT(ofile,this_sds)
    del stitch_vrt
    # append the new SDS to the list sds_set
    sds_set.append(ofile)
    # append the band name to the list bnames
    bnames.append(bandname)

print(sds_set)
print(bnames)
</code></pre>

<pre><code>['work/stitch_MCD15A3H.41.vrt', 'work/stitch_MCD15A3H.45.vrt', 'work/stitch_MCD15A3H.49.vrt']
['2019-041', '2019-045', '2019-049']
</code></pre>
<p>Now we have a set of SDS we want to put them into a VRT file to represent the time series. We do this as we have previously, specifying the outoput name <code>work/stitch_set.vrt</code> here, and ythe listr of SDS that goes in to the time series,<code>sds_set</code> here:</p>
<pre><code class="python"># build a VRT &quot;work/stitch_set.vrt&quot;
stitch_vrt = gdal.BuildVRT(&quot;work/stitch_set.vrt&quot;, sds_set,separate=True)
del stitch_vrt
# test it by reading and plotting
g = gdal.Open(&quot;work/stitch_set.vrt&quot;)
data = g.ReadAsArray()
print(data.shape)
</code></pre>

<pre><code>(3, 2400, 4800)
</code></pre>
<p>The dataset is now 3D. The first dimensions represent the time samples, so:</p>
<pre><code>data[0] -&gt; bnames[0]
</code></pre>
<p>etc.</p>
<pre><code class="python">import numpy as np
for i in range(data.shape[0]):
    print(f'band {bnames[i]} -&gt; mean {np.mean(data[i])}')
</code></pre>

<pre><code>band 2019-041 -&gt; mean 166.24298064236112
band 2019-045 -&gt; mean 166.25176796875
band 2019-049 -&gt; mean 165.74304947916667
</code></pre>
<h4 id="exercise-1">Exercise 1</h4>
<p>We have seen in <a href="../040_GDAL_mosaicing_and_masking/">040_GDAL_mosaicing_and_masking</a> that you can use <code>gdal</code> to creat a GeoTiff format image, for example with:</p>
<pre><code>g = gdal.Warp(output_name, input_name ,format='GTiff',options=['COMPRESS=LZW'])
g.FlushCache()
</code></pre>
<ul>
<li>Convert the <code>gdal</code> file <code>work/stitch_set.vrt</code> to a more portable GeoTiff file called <code>work/stitch_set.tif</code></li>
<li>Confirm that this has worked by reading and displaying data from the file</li>
</ul>
<p>Cut out the UK and visualise as before:</p>
<pre><code class="python"># subset and display

warp_args = {
    'dstNodata'     : 255,
    'format'        : 'MEM',
    'cropToCutline' : True,
    'cutlineWhere'  : &quot;FIPS='UK'&quot;,
    'cutlineDSName' : 'data/TM_WORLD_BORDERS-0.3.shp'
}

g = gdal.Warp(&quot;&quot;, &quot;work/stitch_set.vrt&quot;,**warp_args)
data = g.ReadAsArray()*0.1
print(data.shape)
</code></pre>

<pre><code>(3, 2623, 1394)
</code></pre>
<pre><code class="python">import matplotlib.pyplot as plt

fig, axs = plt.subplots(1,3,figsize=(12,5))
axs = axs.flatten()
for i in range(data.shape[0]):
    im = axs[i].imshow(data[i],vmax=7,\
                cmap=plt.cm.inferno_r,interpolation='nearest')
    fig.colorbar(im, ax=axs[i])
    axs[i].set_title(bnames[i])
</code></pre>

<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_12_0.png" /></p>
<h3 id="modisget_modis"><code>Modis.get_modis</code></h3>
<p>For convenience, we can again use the function <code>Modis.get_modis</code> to combine these, simply by passing a list of <code>doy</code> values, rather than a single <code>doy</code>.</p>
<pre><code class="python">import gdal
from geog0111.modis import Modis
import matplotlib.pyplot as plt

kwargs = {
    'tile'      :    ['h17v03','h18v03'],
    'product'   :    'MCD15A3H',
    'sds'       :    'Lai_500m',
}
year = 2019
# list of doys we want
doys = [41,45,49]

modis = Modis(**kwargs)

warp_args = {
    'dstNodata'     : 255,
    'format'        : 'MEM',
    'cropToCutline' : True,
    'cutlineWhere'  : &quot;FIPS='UK'&quot;,
    'cutlineDSName' : 'data/TM_WORLD_BORDERS-0.3.shp'
}

mfiles = modis.get_modis(year,doys,warp_args=warp_args)
print(mfiles.keys())
</code></pre>

<pre><code>dict_keys(['Lai_500m', 'bandnames'])
</code></pre>
<p>Now let's mask out invalid data points (<code>&gt; 10.0</code> when scaled by 0.1), and display the results:</p>
<pre><code class="python">import numpy as np

g = gdal.Open(mfiles['Lai_500m'])

# dataset and band nanes
data = g.ReadAsArray()*0.1

# valid mask
data[data&gt;10.0] = np.nan
bnames = mfiles['bandnames']
print(data.shape)
</code></pre>

<pre><code>(3, 2623, 1394)
</code></pre>
<pre><code class="python">import matplotlib.pyplot as plt

fig, axs = plt.subplots(1,3,figsize=(12,5))
axs = axs.flatten()
for i in range(data.shape[0]):
    im = axs[i].imshow(data[i],vmax=7,\
                cmap=plt.cm.inferno_r,interpolation='nearest')
    fig.colorbar(im, ax=axs[i])
    axs[i].set_title(bnames[i])
</code></pre>

<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_17_0.png" /></p>
<h2 id="a-year-of-data">A year of data</h2>
<p>A convenient feature of <code>Modis.get_modis</code> is that we can use wildcards for specifying dates. </p>
<p>So, to get a year of LAI data for Luxembourg, we can specify <code>doys = "*"</code>. Note that we could have chosen any location, but we select a small country to make the running more feasible in a practical session.</p>
<p>If the data are already downloaded into the local cache, it should not take too long to form the time series. It will need to generate the VRT files for how every many files and tile you have requested, so that may take some tens of minutes, even if the HDF files are already generated.</p>
<p>If you are attempting to get data not already in the cache, it will take some considerable time to download these datasets for whole years, for multiple tiles. </p>
<p>If you want to download a dataset that is not covered in these notebooks, you are of course welcome to do so, but plan your work ahead of time, and try to pre-download the data before attempting any processing. In such a case, you should take some code such as that below and paste it into a Python file and run that as a Python script from a command line. You should make sure you set:</p>
<pre><code>'verbose' : True
</code></pre>
<p>in the <code>kwargs</code> dictionary. An example script you can modify is given in <a href="geog0111/get_lai.py">geog0111/get_lai.py</a>.</p>
<pre><code class="python">import gdal
from geog0111.modis import Modis
import matplotlib.pyplot as plt

kwargs = {
    'tile'      :    ['h17v03','h18v03','h17v04','h18v04'],
    'product'   :    'MCD15A3H',
    'year'      :    2019,
    'doy'       :    &quot;*&quot;
}

'''
We will gather the data for the year, 
tiles and product that we are interested in into a VRT file:
'''
modis = Modis(**kwargs)
ifiles = modis.get_modis(kwargs['year'],kwargs['doy'],step=4)
</code></pre>

<pre><code class="python">ifiles.keys()
</code></pre>

<pre><code>dict_keys(['FparExtra_QC', 'FparLai_QC', 'FparStdDev_500m', 'Fpar_500m', 'LaiStdDev_500m', 'Lai_500m', 'bandnames'])
</code></pre>
<p>We can apply <code>warp_args</code> to crop the dataset:</p>
<pre><code class="python">import gdal

warp_args = {
    'dstNodata'     : 255,
    'format'        : 'MEM',
    'cropToCutline' : True,
    'cutlineWhere'  : &quot;FIPS='LU'&quot;,
    'cutlineDSName' : 'data/TM_WORLD_BORDERS-0.3.shp'
}

sds = ['Lai_500m','LaiStdDev_500m','FparLai_QC']

# loop over SDS sets and read into dictionary
mfiles = {'bandnames':ifiles['bandnames']}
for s in sds:
    g = gdal.Warp(&quot;&quot;,ifiles[s],**warp_args)
    mfiles[s] = g.ReadAsArray()
# scale
mfiles['Lai_500m'] = mfiles['Lai_500m'] * 0.1
mfiles['LaiStdDev_500m'] = mfiles['LaiStdDev_500m'] * 0.1
</code></pre>

<p>We can now plot the data on sub-plots:</p>
<pre><code class="python">import matplotlib.pyplot as plt

shape=(8,12)
x_size,y_size=(30,20)

fig, axs = plt.subplots(*shape,figsize=(x_size,y_size))
axs = axs.flatten()
plt.setp(axs, xticks=[], yticks=[])

for i in range(mfiles['Lai_500m'].shape[0]):
    im = axs[i].imshow(mfiles['Lai_500m'][i],vmax=7,cmap=plt.cm.inferno_r,\
                       interpolation='nearest')
    axs[i].set_title(mfiles['bandnames'][i])
    fig.colorbar(im, ax=axs[i])
</code></pre>

<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_24_0.png" /></p>
<h3 id="plotting-time-series">Plotting time series</h3>
<p>We might now want to plot some time series.</p>
<p>First, extract the <code>doy</code> from <code>mfiles['bandnames']</code>:</p>
<pre><code class="python">print(mfiles['bandnames'])
</code></pre>

<pre><code>['2019-001', '2019-005', '2019-009', '2019-013', '2019-017', '2019-021', '2019-025', '2019-029', '2019-033', '2019-037', '2019-041', '2019-045', '2019-049', '2019-053', '2019-057', '2019-061', '2019-065', '2019-069', '2019-073', '2019-077', '2019-081', '2019-085', '2019-089', '2019-093', '2019-097', '2019-101', '2019-105', '2019-109', '2019-113', '2019-117', '2019-121', '2019-125', '2019-129', '2019-133', '2019-137', '2019-141', '2019-145', '2019-149', '2019-153', '2019-157', '2019-161', '2019-165', '2019-169', '2019-173', '2019-177', '2019-181', '2019-185', '2019-189', '2019-193', '2019-197', '2019-201', '2019-205', '2019-209', '2019-213', '2019-217', '2019-221', '2019-225', '2019-229', '2019-233', '2019-237', '2019-241', '2019-245', '2019-249', '2019-253', '2019-257', '2019-261', '2019-265', '2019-269', '2019-273', '2019-277', '2019-281', '2019-285', '2019-289', '2019-293', '2019-297', '2019-301', '2019-305', '2019-309', '2019-313', '2019-317', '2019-321', '2019-325', '2019-329', '2019-333', '2019-337', '2019-341', '2019-345', '2019-349', '2019-353', '2019-357', '2019-361', '2019-365']
</code></pre>
<pre><code class="python"># convert to 1 by splitting the string
test = '2019-001'
int(test.split('-')[1])
</code></pre>

<pre><code>1
</code></pre>
<pre><code class="python">doy = [int(i.split('-')[1]) for i in mfiles['bandnames']]
print(doy)
</code></pre>

<pre><code>[1, 5, 9, 13, 17, 21, 25, 29, 33, 37, 41, 45, 49, 53, 57, 61, 65, 69, 73, 77, 81, 85, 89, 93, 97, 101, 105, 109, 113, 117, 121, 125, 129, 133, 137, 141, 145, 149, 153, 157, 161, 165, 169, 173, 177, 181, 185, 189, 193, 197, 201, 205, 209, 213, 217, 221, 225, 229, 233, 237, 241, 245, 249, 253, 257, 261, 265, 269, 273, 277, 281, 285, 289, 293, 297, 301, 305, 309, 313, 317, 321, 325, 329, 333, 337, 341, 345, 349, 353, 357, 361, 365]
</code></pre>
<p>It is interesting to see a set of sub-plots for a range of pixel locations. We can follow tghe approach we have taken to sub-plots previously, but now we want to make use of the 2D nature of the sub-plot <code>axs</code> variable (recall that previously we have flattened this to a 1D representation).</p>
<p>We will define a sub-plot shape: <code>shape=(10,10)</code> and a starting pixel <code>pixel = (100,70)</code>. We will then loop in row and column to produce the sub-plots:</p>
<pre><code class="python">import matplotlib.pyplot as plt

x_size,y_size=(20,20)

shape=(10,10)
fig, axs = plt.subplots(*shape,figsize=(x_size,y_size))
plt.setp(axs, xticks=[], yticks=[])

pixel = (100,70)
x = doy

for i in range(shape[0]):
    p0 = pixel[0] + i
    for j in range(shape[1]):
        p1 = pixel[1] + j
        im = axs[i,j].plot(x,mfiles['Lai_500m'][:,p0,p1])
        axs[i,j].set_title(f'{p0} {p1}')
        # ensure the same scale for all
        axs[i,j].set_ylim(0,7)
</code></pre>

<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_30_0.png" /></p>
<h4 id="exercise-2">Exercise 2</h4>
<ul>
<li>
<p>Write a function called <code>modis_annual_dataset</code>that takes <code>year</code>,<code>tile</code> and <code>product</code> and <code>step</code> and returns a dictionary of appropriate MODIS datasets. </p>
</li>
<li>
<p>Write another function <code>get_modis_annual</code> that takes the dictionary of appropriate MODIS datasets. and generates a dictionary of MODIS data values, filtered according to information of the form:</p>
<pre><code>warp_args = {
    'dstNodata'     : 255,
    'format'        : 'MEM',
    'cropToCutline' : True,
    'cutlineWhere'  : "FIPS='LU'",
    'cutlineDSName' : 'data/TM_WORLD_BORDERS-0.3.shp'
}

sds = ['Lai_500m','LaiStdDev_500m','FparLai_QC']
</code></pre>
</li>
<li>
<p>Write a third function <code>modis_annual</code> that combines these two functions.</p>
</li>
<li>Test your code and plot some results</li>
</ul>
<h2 id="uncertainty-and-weighting">Uncertainty and weighting</h2>
<p>The full set of SDS available is </p>
<pre><code>['Fpar_500m',
 'Lai_500m',
 'FparLai_QC',
 'FparExtra_QC',
 'FparStdDev_500m',
 'LaiStdDev_500m']
</code></pre>
<p>We should always examine any uncertainty information available when trying to interpret a dataset. In this exercise, we will take the uncertainty, defined as a standard deviation, and generate a weight from this in the form:</p>
<pre><code>W  = 1/(std * std)
</code></pre>
<p>where std is the uncertainty. Where this weighting is high, we can put more emphasis on the reliability of the data than when it is low.</p>
<p>First then, read all SDS:</p>
<pre><code class="python">import gdal
import matplotlib.pyplot as plt
from geog0111.modis_annual import modis_annual

warp_args = {
  'dstNodata'     : 255,
  'format'        : 'MEM',
  'cropToCutline' : True,
  'cutlineWhere'  : &quot;FIPS='LU'&quot;,
  'cutlineDSName' : 'data/TM_WORLD_BORDERS-0.3.shp'
}
sds     = ['Lai_500m','LaiStdDev_500m','FparLai_QC']
tile    = ['h17v03','h18v03','h17v04','h18v04']
product = 'MCD15A3H'
year    = 2019
step    = 4

mfiles = modis_annual(year,tile,product,sds=sds,step=step,warp_args=warp_args)

print(f'dataset keys : {mfiles.keys()}')
print(f'dataset shape: {mfiles[&quot;Lai_500m&quot;].shape}')
print(f'dataset size : {mfiles[&quot;Lai_500m&quot;].size/(1024**2): .2f} MB')
</code></pre>

<pre><code>dataset keys : dict_keys(['bandnames', 'Lai_500m', 'LaiStdDev_500m', 'FparLai_QC'])
dataset shape: (92, 175, 122)
dataset size :  1.87 MB
</code></pre>
<pre><code class="python"># scale
mfiles['Lai_500m'] = mfiles['Lai_500m'] * 0.1
mfiles['LaiStdDev_500m'] = mfiles['LaiStdDev_500m'] * 0.1
</code></pre>

<p>There is a feature in the <code>LaiStdDev_500m</code> dataset where some pixels have apparently zero uncertainty. Indeed, all LAI values with an uncertainty under 1.0 seem suspect as individual values. So we treat them hear, to set all values less than 1 to 1.</p>
<p>We know that LAI values over 10 (100 * 0.1) are invalid, so we should make sure these are also weighted zero:</p>
<pre><code class="python">import numpy as np

weight = np.zeros_like(mfiles['LaiStdDev_500m'])
std = mfiles['LaiStdDev_500m']

# fix low values
std[std&lt;1.0] = 1.0

mask = (std &gt; 0)
weight[mask] = 1./(std[mask]**2)

weight[mfiles['Lai_500m'] &gt; 10] = 0.
weight[mfiles['LaiStdDev_500m']==0] = 0.
# look at some stats
print(weight.min(),weight.max())
</code></pre>

<pre><code>0.0 1.0
</code></pre>
<p>We can now go ahead and plot the dataset and the weights. We switch to a greyscale colourmap to make the interpretation of numbers easier.</p>
<pre><code class="python"># produce image plots of the both quantities
import matplotlib.pyplot as plt

shape=(8,12)
x_size,y_size=(30,20)

fig, axs = plt.subplots(*shape,figsize=(x_size,y_size))
axs = axs.flatten()
plt.setp(axs, xticks=[], yticks=[])
fig.suptitle(&quot;LAI Luxembourg 2019&quot;)
for i in range(mfiles['Lai_500m'].shape[0]):
    im = axs[i].imshow(mfiles['Lai_500m'][i],vmax=7,cmap=plt.cm.gray,\
                       interpolation='nearest')
    axs[i].set_title(mfiles['bandnames'][i])
    fig.colorbar(im, ax=axs[i])
</code></pre>

<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_39_0.png" /></p>
<pre><code class="python"># Plot the weight
import matplotlib.pyplot as plt

shape=(8,12)
x_size,y_size=(30,20)

fig, axs = plt.subplots(*shape,figsize=(x_size,y_size))
axs = axs.flatten()
plt.setp(axs, xticks=[], yticks=[])
fig.suptitle(&quot;LAI weight Luxembourg 2019&quot;)

for i in range(mfiles['Lai_500m'].shape[0]):
    im = axs[i].imshow(weight[i],vmax=1,cmap=plt.cm.gray,\
                       interpolation='nearest')
    axs[i].set_title(mfiles['bandnames'][i])
    fig.colorbar(im, ax=axs[i])
</code></pre>

<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_40_0.png" /></p>
<pre><code class="python"># LAI time series
import matplotlib.pyplot as plt
doy = [int(i.split('-')[1]) for i in mfiles['bandnames']]

x_size,y_size=(20,20)

shape=(10,10)
fig, axs = plt.subplots(*shape,figsize=(x_size,y_size))
plt.setp(axs, xticks=[], yticks=[])

pixel = (100,70)
x = doy

for i in range(shape[0]):
    p0 = pixel[0] + i
    for j in range(shape[1]):
        p1 = pixel[1] + j
        im = axs[i,j].plot(x,mfiles['Lai_500m'][:,p0,p1])
        axs[i,j].set_title(f'{p0} {p1}')
        # ensure the same scale for all
        axs[i,j].set_ylim(0,7)
</code></pre>

<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_41_0.png" /></p>
<pre><code class="python"># weight time series plots 
import matplotlib.pyplot as plt
doy = [int(i.split('-')[1]) for i in mfiles['bandnames']]

x_size,y_size=(20,20)

shape=(10,10)
fig, axs = plt.subplots(*shape,figsize=(x_size,y_size))
plt.setp(axs, xticks=[], yticks=[])

pixel = (100,70)
x = doy

for i in range(shape[0]):
    p0 = pixel[0] + i
    for j in range(shape[1]):
        p1 = pixel[1] + j
        im = axs[i,j].plot(x,weight[:,p0,p1])
        axs[i,j].set_title(f'{p0} {p1}')
        # ensure the same scale for all
        axs[i,j].set_ylim(0,1)
</code></pre>

<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_42_0.png" /></p>
<p>We can look at an individual plot now, and use the weights for error bars.</p>
<p>In this case, we want to convert the array <code>weight</code> to an array <code>error</code>, applying the opposite of what we did above to get standard deviation, and multiplying by <a href="https://en.wikipedia.org/wiki/1.96">1.96</a>.</p>
<p>We want to avoid the division <code>1/0</code>, so we first build an array the same as weight, but fiulled with zero values:</p>
<pre><code>error = np.zeros_like(weight)
</code></pre>
<p>and then only do the division for the mask <code>weight&gt;0</code>:</p>
<pre><code>error[weight&gt;0] = np.sqrt(1./(weight[weight&gt;0] )) * 1.96
</code></pre>
<pre><code class="python">import matplotlib.pyplot as plt

error = np.zeros_like(weight)
error[weight&gt;0] = np.sqrt(1./(weight[weight&gt;0] )) * 1.96

doy = [int(i.split('-')[1]) for i in mfiles['bandnames']]
p0,p1 = (107,72)
x_size,y_size=(10,5)

shape=(10,10)
fig, axs = plt.subplots(1,1,figsize=(x_size,y_size))

pixel = (100,70)
x = doy

axs.errorbar(x,mfiles['Lai_500m'][:,p0,p1],yerr=error[:,p0,p1]/10)
axs.set_title(f'{p0} {p1}')
# ensure the same scale for all
axs.set_ylim(0,7)
axs.set_xlabel('DOY 2019')
axs.set_ylabel('LAI')
</code></pre>

<pre><code>Text(0, 0.5, 'LAI')
</code></pre>
<p><img alt="png" src="041_GDAL_timeseries_files/041_GDAL_timeseries_44_1.png" /></p>
<p>We might question the validity of some of the LAI uncertainty here: we expect LAI to have a smnooth trajectory in time, but that is clearly not always the case here. However, they provide a traceable estimate of the reliability of each individual measurement and are useful in that respect.</p>
<h4 id="exercise-3">Exercise 3</h4>
<ul>
<li>Write a function <code>get_lai_data</code> that takes as argument:<pre><code>year : integer year
tile : list of tiles to process
fips : country fips code (e.g. BE for Belgium)
</code></pre>
</li>
</ul>
<p>and returns the annual LAI, standard deviation and day of year</p>
<ul>
<li>test your code for Belgium for 2018 for tiles <code>['h17v03','h18v03','h17v04','h18v04']</code></li>
<li>show the shape of the arrays returned</li>
</ul>
<p>Hint: You may find it useful to use <code>geog0111.modis_annual</code></p>
<h2 id="summary">Summary</h2>
<p>We now know how to combine geospatial data in both space and time VRT files using <code>gdal</code>. Remember that we can also do such things using <code>numpy</code>, but if we are able to keep the geospatial information and other metadata in a <code>gdal</code> file, so much the better. We have seen how to write the dataset to a portable file format such as GeoTiff.</p>
<p>We have seen that some datasets such as the MODIS LAI product come with a per-pixel estimate of uncertainty. We have investigated this data field and used it to provide a weighting to associate with the reliability of each pixel. We have seen how to generate, filter, and process 3D spatio-temporal datasets. The examples here </p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../042_Weighted_smoothing_and_interpolation/" class="btn btn-neutral float-right" title="Weighted Smoothing And Interpolation">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../040_GDAL_mosaicing_and_masking/" class="btn btn-neutral" title="GDAL Mosaicing And Masking"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/UCL-EO/geog0111/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../040_GDAL_mosaicing_and_masking/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../042_Weighted_smoothing_and_interpolation/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
